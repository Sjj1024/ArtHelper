import{d as e,r as a,j as t,B as i,h as s,m as r}from"./index-efa3a32c.js";import{F as l}from"./index-ae2d5997.js";import{I as d}from"./index-8c8b720f.js";import{a as o}from"./index-639ffc53.js";import"./index-0373e759.js";/* empty css              */import"./index-9b480cfe.js";import"./index-9b8a3313.js";import{P as n}from"./index-94ed3db3.js";import{D as p}from"./index-65748fb5.js";import{I as m}from"./index-06b8a89d.js";import{D as u}from"./index-1acfbbfd.js";import"./index-47693ae2.js";import{h as c}from"./hado-a6960cf0.js";import{a as x}from"./app-4adb5e72.js";import{u as g}from"./useSetState-78ffd672.js";import{M as y}from"./index-46e73bcd.js";import{S as j}from"./index-1c1deade.js";import{P as h}from"./PlusCircleOutlined-176a31dc.js";import"./context-cb88fb1e.js";import"./responsiveObserve-b13564d4.js";import"./index-177532f7.js";import"./statusUtils-b010cbea.js";import"./EyeOutlined-319494bf.js";import"./SearchOutlined-03c63d28.js";import"./pickAttrs-1cd23dfa.js";import"./index-40784afc.js";import"./getScrollBarSize-c6833c2b.js";import"./isEqual-8ee5b3ce.js";import"./useForceUpdate-9ad39bdf.js";import"./index-0a1440ec.js";import"./ActionButton-e012fb99.js";import"./CalendarOutlined-8ff6678f.js";import"./Portal-08554165.js";import"./CheckOutlined-f0d55485.js";function f(){document.title="卡券管理";const f=e((e=>e.app.powersCode)),[w]=l.useForm(),[S,I]=a.useState([]),[C,k]=a.useState(!1),[T,b]=g({pageNum:1,pageSize:10,total:0}),[v,L]=g({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1}),N={cardName:"",cardType:void 0,fullLimit:"",cardValue:"",store:[],type:[],margin:"",lifespan:""},z=(e,a)=>{L({operateType:a,nowData:e,modalShow:!0,modalLoading:!1}),e?w.setFieldsValue({cardName:e.cardName,cardType:e.cardType,fullLimit:e.fullLimit,cardValue:e.cardValue,store:e.storeId.split(","),type:e.typeId.split(","),margin:e.margin,lifespan:s(e.lifespan)}):w.setFieldsValue({...N})},V=()=>{w.setFieldsValue({...N}),L({modalShow:!1})},D=async e=>{const a={page:e.pageNum,limit:e.pageSize,status:null};k(!0);try{const t=await x.cardList(a);t&&200===t.code?(I(t.data),b({total:t.count,pageNum:e.pageNum,pageSize:e.pageSize})):r.error((null==t?void 0:t.message)??"获取失败")}finally{k(!1)}},[Y,q]=a.useState([]),[F,M]=a.useState([]),O=[{title:"id",dataIndex:"id",key:"id"},{title:"卡券名称",dataIndex:"cardName",key:"cardName"},{title:"卡券类型",dataIndex:"cardType",key:"cardType"},{title:"满额限制",dataIndex:"fullLimit",key:"fullLimit"},{title:"卡券价值",dataIndex:"cardValue",key:"cardValue"},{title:"适用门店",dataIndex:"store",key:"store"},{title:"适用类型",dataIndex:"type",key:"type"},{title:"有效期",dataIndex:"lifespan",key:"lifespan"},{title:"使用数量",dataIndex:"useCount",key:"useCount"},{title:"领取数量",dataIndex:"getCount",key:"getCount"},{title:"余量",dataIndex:"margin",key:"margin"},{title:"状态",dataIndex:"status",key:"status",render:e=>1===e?"正常":"冻结"},{title:"创建者",dataIndex:"creator",key:"creator"},{title:"上次修改",dataIndex:"lastChange",key:"lastChange"},{title:"创建时间",dataIndex:"createTime",key:"createTime"},{title:"操作",key:"control",fixed:"right",width:120,render:(e,a)=>{const i=[];f.includes("card:edit")&&i.push(t.jsx("span",{style:{color:" rgb( 66,149,229)",cursor:"pointer"},onClick:()=>z(a,"edit"),children:"编辑"},"1")),f.includes("card:freeze")&&i.push(t.jsx(n,{title:1===a.status?"确定设置为冻结吗？":"确定设置为正常吗？",onConfirm:()=>{(async e=>{const a=await x.cardStatus({uuid:e.uuid,status:1===e.status?0:1});a&&200===a.code?(r.success("修改成功"),D(T)):r.error((null==a?void 0:a.message)??"修改成功")})(a)},okText:"确定",cancelText:"取消",children:t.jsx("span",{style:{color:" rgb( 66,149,229)",cursor:"pointer"},children:1===a.status?"冻结":"激活"})},"2"));const s=[];return i.forEach(((e,a)=>{a&&s.push(t.jsx(p,{type:"vertical"},`line${a}`)),s.push(e)})),s}}],A=a.useMemo((()=>S.map(((e,a)=>({uuid:e.uuid,serial:a+1+(T.pageNum-1)*T.pageSize,id:e.id,cardName:e.courtesyname,fullLimit:e.usagelimitation,cardValue:e.courtesyprice,storeId:e.provideruuidlist,store:e.providerlist_name,typeId:e.usagerole,type:e.usagerole_name,lifespan:e.exptime,useCount:e.usedstatic,getCount:e.tokenstatic,margin:e.leftstatic,status:e.status,creatorId:e.owneruuid,creator:e.owner_name,lastChangeId:e.updateruuid,lastChange:e.updater_name,createTime:e.addtime,cardType:"满减券"})))),[T,S]);return a.useEffect((()=>{D(T),(async()=>{const e=await c.allShopSelect({});e&&200===e.code&&q(e.data.map((e=>({value:e.uuid,label:e.providername}))))})(),(async()=>{const e=await x.scopeList({});if(e&&200===e.code){const a=e.data.map((e=>({value:e.id.toString(),label:e.name})));M(a)}})()}),[]),t.jsxs("div",{children:[t.jsx("div",{children:t.jsx("ul",{style:{textAlign:"right"},children:f.includes("card:add")&&t.jsx("li",{children:t.jsx(i,{type:"primary",icon:t.jsx(h,{}),disabled:!f.includes("card:add"),onClick:()=>z(null,"add"),children:"新建卡券"})})})}),t.jsx("div",{children:t.jsx(o,{columns:O,loading:C,dataSource:A,scroll:{x:"max-content"},pagination:{total:T.total,current:T.pageNum,pageSize:T.pageSize,showQuickJumper:!1,showTotal:e=>`共 ${e} 条数据`,onChange:(e,a)=>((e,a)=>{D({pageNum:e,pageSize:a||T.pageSize})})(e,a)}})}),t.jsx(y,{title:{add:"创建卡券",edit:"编辑卡券"}[v.operateType],open:v.modalShow,cancelText:"取消",okText:"确认",onOk:async()=>{try{L({modalLoading:!0});const e=await w.validateFields();if("add"===v.operateType){const a={courtesyname:e.cardName,property:e.cardType,courtesyprice:e.cardValue,usagelimitation:e.fullLimit,totalusage:e.margin,exptime:e.lifespan.format("YYYY-MM-DD")+" 23:59:59",provideruuidlist:e.store.toString(),usagerole:e.type.toString()},t=await x.addCard(a);t&&200===t.code?(r.success("添加成功"),D(T),V()):r.error((null==t?void 0:t.message)??"添加失败")}else if("edit"===v.operateType){const a={uuid:v.nowData.uuid,courtesyname:e.cardName,property:1,courtesyprice:e.cardValue,usagelimitation:e.fullLimit,totalusage:e.margin,exptime:e.lifespan.format("YYYY-MM-DD")+" 23:59:59",provideruuidlist:e.store.toString(),usagerole:e.type.toString()},t=await x.editCard(a);t&&200===t.code?(r.success("修改成功"),D(T),V()):r.error((null==t?void 0:t.message)??"修改失败")}}finally{L({modalLoading:!1})}},onCancel:()=>V(),confirmLoading:v.modalLoading,children:t.jsxs(l,{form:w,initialValues:{formConditions:1},labelCol:{span:6},children:[t.jsx(l.Item,{label:"卡券名称",name:"cardName",rules:[{required:!0,whitespace:!0,message:"请输入卡券名称"},{max:26,message:"最多输入26位字符"}],children:t.jsx(d,{style:{width:"300px"},placeholder:"请输入"})}),t.jsx(l.Item,{name:"cardType",label:"卡券类型",rules:[{required:!0,message:"请选择卡券类型"}],children:t.jsx(j,{style:{width:"300px"},placeholder:"请选择",allowClear:!0,options:[{value:1,label:"满减券"}]})}),t.jsx(l.Item,{label:"满额限制",name:"fullLimit",rules:[{required:!0,message:"请输入满额限制"}],children:t.jsx(m,{style:{width:"300px"},placeholder:"请输入",addonAfter:"元",min:0,precision:0,step:1,max:9999,disabled:"edit"===v.operateType})}),t.jsx("div",{style:{color:"rgb(164,164,164)",position:"absolute",top:"225px",right:"70px",fontSize:"10px"},children:"（输入0时为无门槛券）"}),t.jsx(l.Item,{label:"卡券价值",name:"cardValue",rules:[{required:!0,message:"请输入卡券价值"}],children:t.jsx(m,{style:{width:"300px"},placeholder:"请输入",addonAfter:"元",step:1,min:0,precision:0,max:999,disabled:"edit"===v.operateType})}),t.jsx(l.Item,{name:"store",label:"适用门店",rules:[{required:!0,message:"请选择适用门店"}],children:t.jsx(j,{style:{width:"300px"},mode:"multiple",allowClear:!0,placeholder:"请选择",onChange:e=>{},options:Y})}),t.jsx(l.Item,{name:"type",label:"适用类型",rules:[{required:!0,message:"请选择适用类型"}],children:t.jsx(j,{style:{width:"300px"},mode:"multiple",allowClear:!0,placeholder:"请选择",onChange:e=>{},options:F})}),t.jsx(l.Item,{label:"卡券数量",name:"margin",rules:[{required:!0,message:"请输入卡券数量"}],children:t.jsx(m,{style:{width:"300px"},placeholder:"请输入",min:1,precision:0,step:1,max:99999})}),t.jsx(l.Item,{name:"lifespan",label:"有效期",rules:[{required:!0,message:"请选择有效期"}],children:t.jsx(u,{format:"YYYY-MM-DD",style:{width:"200px"},disabled:"edit"===v.operateType})})]})})]})}export{f as default};
