import{a as e,d as o,r as s,b as a,m as t,j as r,B as i,T as l}from"./index-efa3a32c.js";import{F as n}from"./index-ae2d5997.js";import{I as d}from"./index-8c8b720f.js";import{a as u}from"./index-639ffc53.js";import"./index-0373e759.js";/* empty css              */import"./index-9b480cfe.js";import"./index-9b8a3313.js";import{P as m}from"./index-94ed3db3.js";import{D as p}from"./index-65748fb5.js";import{I as c}from"./index-06b8a89d.js";import{u as x}from"./user-66ba9e41.js";import{T as w}from"./PowerTreeTable-a796c563.js";import{u as j}from"./useSetState-78ffd672.js";import{P as y}from"./PlusCircleOutlined-176a31dc.js";import{M as g}from"./index-46e73bcd.js";import{S as f}from"./index-1c1deade.js";import{E as h}from"./EditOutlined-e081177a.js";import{S as v,C as S}from"./StopOutlined-b809cae3.js";import{T}from"./ToolOutlined-0d0725ac.js";import"./context-cb88fb1e.js";import"./responsiveObserve-b13564d4.js";import"./index-177532f7.js";import"./statusUtils-b010cbea.js";import"./EyeOutlined-319494bf.js";import"./SearchOutlined-03c63d28.js";import"./pickAttrs-1cd23dfa.js";import"./index-40784afc.js";import"./getScrollBarSize-c6833c2b.js";import"./isEqual-8ee5b3ce.js";import"./useForceUpdate-9ad39bdf.js";import"./index-0a1440ec.js";import"./ActionButton-e012fb99.js";import"./Portal-08554165.js";import"./CheckOutlined-f0d55485.js";const{TextArea:k}=d,b={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:19}}};function I(){var I,D;document.title="角色管理";const O=e(),A=o((e=>e.app.powersCode)),P=o((e=>e.sys.powerTreeData)),[C]=n.useForm(),[L,N]=s.useState([]),[z,R]=s.useState(!1),[q,F]=j({pageNum:1,pageSize:10,total:0}),[E,$]=j({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1});j({title:void 0,conditions:void 0});const[B,V]=j({treeOnOkLoading:!1,powerTreeShow:!1,powerTreeDefault:{menus:[],powers:[]}});s.useEffect((()=>{U(q),M(),W()}),[]);const M=()=>{const e=a.getAllMenusAndPowers().data;O.sys.reducerSetAllPowers(e)},U=async e=>{if(!A.includes("role:query"))return;const o={page:e.pageNum,limit:e.pageSize};R(!0);try{const s=await x.getRolesList(o);s&&200===s.code?(N(s.data),F({total:s.cont,pageNum:e.pageNum,pageSize:e.pageSize})):t.error((null==s?void 0:s.message)??"获取失败")}finally{R(!1)}},[J,Q]=s.useState({uuid:"",powerlist:{}}),G=(e,o)=>{$({modalShow:!0,nowData:e,operateType:o}),setTimeout((()=>{var s;if("add"===o)C.setFieldsValue({rolename:"",proxy:"",store:"",desc:"",limit:""});else{if(Q({uuid:e.uuid,powerlist:{menuAndPowers:e.menuAndPowers}}),e.proxy&&"-"!==e.proxy){const o=null==(s=H.find((o=>o.label===e.proxy||o.value===e.proxy)))?void 0:s.value;Z(o)}C.setFieldsValue({rolename:e.title,proxy:"-"===e.proxy?"":e.proxyId,store:"-"===e.store?"":e.storeId,desc:e.desc,limit:e.limit.split("/")[1]})}}))},[H,K]=s.useState([]),W=async()=>{const e=(await x.getAgents()).data.map((e=>({label:e.providername,value:e.uuid})));K(e)},[X,Y]=s.useState([]),Z=async e=>{const o=(await x.getStores({agenuuid:e})).data.map((e=>({label:e.providername,value:e.uuid})));Y(o)},_=()=>{C.setFieldsValue({rolename:"",proxy:"",store:"",desc:"",limit:""}),$({modalShow:!1})},ee=()=>{V({powerTreeShow:!1})},oe=[{title:"编号",dataIndex:"serial",key:"serial"},{title:"角色名称",dataIndex:"title",key:"title"},{title:"所属门店",dataIndex:"store",key:"store"},{title:"所属代理",dataIndex:"proxy",key:"proxy"},{title:"角色说明",dataIndex:"desc",key:"desc"},{title:"数量限制",dataIndex:"limit",key:"limit"},{title:"状态",dataIndex:"conditions",key:"conditions",render:e=>1===e?r.jsx("span",{style:{color:"green"},children:"启用"}):r.jsx("span",{style:{color:"red"},children:"禁用"})},{title:"操作",key:"control",width:200,render:(e,o)=>{const s=[];A.includes("role:up")&&s.push(r.jsx("span",{className:"control-btn blue",onClick:()=>G(o,"up"),children:r.jsx(l,{placement:"top",title:"编辑角色",children:r.jsx(h,{})})},"1")),A.includes("role:power")&&s.push(r.jsx("span",{className:"control-btn blue",onClick:()=>(e=>{const o=e.menuAndPowers.map((e=>e.menuId)),s=e.menuAndPowers.reduce(((e,o)=>[...e,...o.powers]),[]);$({nowData:e}),V({powerTreeShow:!0,powerTreeDefault:{menus:o,powers:s}})})(o),children:r.jsx(l,{placement:"top",title:"分配权限",children:r.jsx(T,{})})},"2")),A.includes("role:del")&&s.push(r.jsx(m,{title:1===o.status?"确定禁用吗？":"确定启用吗？",onConfirm:()=>(async e=>{R(!0);try{let o;o=1===e.status?await x.closeRole({uuid:e.uuid}):await x.openRole({uuid:e.uuid}),o&&200===o.code?(t.success("删除成功"),U(q)):t.error((null==o?void 0:o.message)??"操作失败")}finally{R(!1)}})(o),okText:"确定",cancelText:"取消",children:r.jsx("span",{className:"control-btn red",children:r.jsx(l,{placement:"top",title:1===o.status?"禁用":"启用",children:1===o.status?r.jsx(v,{}):r.jsx(S,{style:{color:"green"}})})})},"3"));const a=[];return s.forEach(((e,o)=>{o&&a.push(r.jsx(p,{type:"vertical"},`line${o}`)),a.push(e)})),a}}],se=s.useMemo((()=>L.map(((e,o)=>({key:e.id,uuid:e.uuid,serial:o+1+(q.pageNum-1)*q.pageSize,title:e.rolename,store:e.providerinfor?e.providerinfor.providername:"-",storeId:e.providerinfor?e.providerinfor.uuid:"-",proxy:e.agentinfor?e.agentinfor.providername:"-",proxyId:e.agentinfor?e.agentinfor.uuid:"-",limit:`${e.usernum}/${e.maxvolumne}`,maxLimit:e.maxvolumne,usedLimit:e.usernum,desc:e.roledetail?e.roledetail.remarks:"-",sorts:1,conditions:e.deletedtime?0:1,status:e.deletedtime?0:1,control:1,menuAndPowers:e.roledetail&&e.roledetail.powerlist?e.roledetail.powerlist.menuAndPowers:[]})))),[q,L]);return r.jsxs("div",{className:"role-box",children:[r.jsx("div",{className:"role-search",children:r.jsx("ul",{className:"search-func",children:A.includes("role:add")&&r.jsx("li",{children:r.jsx(i,{type:"primary",icon:r.jsx(y,{}),disabled:!A.includes("role:add"),onClick:()=>G(null,"add"),children:"新增角色"})})})}),r.jsx("div",{className:"diy-table",children:r.jsx(u,{columns:oe,loading:z,dataSource:se,pagination:{total:q.total,current:q.pageNum,pageSize:q.pageSize,showQuickJumper:!1,showTotal:e=>`共 ${e} 条数据`,onChange:(e,o)=>((e,o)=>{U({pageNum:e,pageSize:o||q.pageSize})})(e,o)}})}),r.jsx(g,{title:{add:"新增角色",up:"编辑角色",see:"查看"}[E.operateType],open:E.modalShow,cancelText:"取消",okText:"确认",onOk:()=>(async()=>{var e,o;if("see"!==E.operateType)try{const s=await C.validateFields();if($({modalLoading:!0}),"add"===E.operateType){const e={rolename:s.rolename,useruuid:s.proxy,provideruuid:s.store,maxvolumne:s.limit,powerlist:{menuAndPowers:[{menuId:0,powers:[]}]},remarks:s.desc};try{const o=await x.addRole(e);o&&200===o.code&&(t.success("添加成功"),U(q),_())}finally{$({modalLoading:!1})}}else{const a=null==(e=X.find((e=>e.label===s.store||e.value===s.store)))?void 0:e.value,r=null==(o=H.find((e=>e.label===s.proxy||e.value===s.proxy)))?void 0:o.value,i={uuid:J.uuid,rolename:s.rolename,useruuid:r,provideruuid:a,maxvolumne:s.limit,powerlist:J.powerlist,remarks:s.desc};try{const e=await x.updateRole(i);e&&200===e.code&&(t.success("修改成功"),U(q),_())}finally{$({modalLoading:!1})}}}catch{}else _()})(),onCancel:()=>_(),confirmLoading:E.modalLoading,children:r.jsxs(n,{form:C,initialValues:{formConditions:1},children:[r.jsx(n.Item,{label:"角色名称",name:"rolename",...b,rules:[{required:!0,whitespace:!0,message:"请输入角色名称"},{max:20,message:"最多输入20位字符"}],children:r.jsx(d,{placeholder:"请输入角色名",disabled:"see"===E.operateType})}),r.jsx(n.Item,{label:"所属代理",name:"proxy",...b,rules:[{required:!0,message:"请选择所属代理"}],children:r.jsx(f,{disabled:"see"===E.operateType,options:H,value:null==(I=E.nowData)?void 0:I.proxyId,onSelect:Z,placeholder:"请选择所属代理"})}),r.jsx(n.Item,{label:"所属门店",name:"store",...b,rules:[{required:!0,message:"请选择所属门店"}],children:r.jsx(f,{disabled:"see"===E.operateType,options:X,value:null==(D=E.nowData)?void 0:D.storeId,placeholder:"请选择所属门店"})}),r.jsx(n.Item,{label:"角色描述",name:"desc",...b,rules:[{max:200,message:"最多输入200个字符"},{required:!0,message:"请输入角色描述"}],children:r.jsx(k,{rows:4,disabled:"see"===E.operateType,autoSize:{minRows:2,maxRows:6}})}),r.jsx(n.Item,{label:"数量限制",name:"limit",...b,rules:[{required:!0,message:"请输入数量限制"}],children:r.jsx(c,{min:0,max:99,style:{width:"100%"},disabled:"see"===E.operateType})})]})}),r.jsx(w,{title:E.nowData?`权限：${E.nowData.title}`:"分配权限",data:P,defaultChecked:B.powerTreeDefault,loading:B.treeOnOkLoading,modalShow:B.powerTreeShow,onOk:async e=>{var o;if(!(null==(o=null==E?void 0:E.nowData)?void 0:o.uuid))return void t.error("该数据没有ID");const s={id:E.nowData.uuid,menus:e.menus,powers:e.powers};V({treeOnOkLoading:!0});try{const e=a.setPowersByRoleId(s),o={uuid:E.nowData.uuid,rolename:E.nowData.title,useruuid:E.nowData.proxyId,provideruuid:E.nowData.storeId,maxvolumne:E.nowData.maxLimit,powerlist:{menuAndPowers:e.data},remarks:E.nowData.desc},r=await x.updateRole(o);r&&200===r.code?(t.success("操作成功"),U(q),ee()):t.error((null==r?void 0:r.message)??"权限分配失败")}finally{V({treeOnOkLoading:!1})}},onClose:ee})]})}export{I as default};
