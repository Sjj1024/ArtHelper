import{a as e,d as s,r as t,l as o,j as i,m as r,T as a}from"./index-efa3a32c.js";import{T as l,a as n}from"./index-639ffc53.js";import{C as d}from"./index-0373e759.js";/* empty css              */import{I as m}from"./index-8c8b720f.js";import"./index-9b480cfe.js";import"./index-9b8a3313.js";import{P as c}from"./index-94ed3db3.js";import{F as p}from"./index-ae2d5997.js";import{I as u}from"./index-06b8a89d.js";import{D as j}from"./index-65748fb5.js";import{u as x}from"./useSetState-78ffd672.js";import{u as h}from"./useMount-5c373398.js";import{M as f}from"./index-46e73bcd.js";import{S as y}from"./index-1c1deade.js";import{E as w}from"./EyeOutlined-a014c032.js";import{T as g}from"./ToolOutlined-0d0725ac.js";import{D as v}from"./DeleteOutlined-866c7b58.js";import"./pickAttrs-1cd23dfa.js";import"./index-40784afc.js";import"./getScrollBarSize-c6833c2b.js";import"./isEqual-8ee5b3ce.js";import"./useForceUpdate-9ad39bdf.js";import"./SearchOutlined-03c63d28.js";import"./index-0a1440ec.js";import"./context-cb88fb1e.js";import"./index-177532f7.js";import"./statusUtils-b010cbea.js";import"./EyeOutlined-319494bf.js";import"./responsiveObserve-b13564d4.js";import"./ActionButton-e012fb99.js";import"./Portal-08554165.js";import"./CheckOutlined-f0d55485.js";import"./DeleteOutlined-6b999003.js";const{Option:b}=y,{TextArea:T}=m,C={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:19}}};function I(){var I;document.title="权限管理";const S=e(),k=s((e=>e.app.powersCode)),D=s((e=>e.sys.roles)),A=s((e=>e.app.userinfo)),[O]=p.useForm(),[P,N]=t.useState([]),[q,M]=t.useState(!1),[E,F]=x({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1}),[L,R]=t.useState([]),[U,$]=t.useState({});h((()=>{0===A.menus.length&&S.sys.getMenus(),S.sys.getAllRoles(),B()}));const B=async(e=null)=>{if(!k.includes("power:query"))return;M(!0);const s={menuId:Number(e)||null};try{const e=await S.sys.getPowerDataByMenuId(s);e&&200===e.status&&N(e.data)}finally{M(!1)}},z=t.useCallback(((e,s)=>{let t;return t=e?s.filter((s=>s.parent===e.id)):s.filter((e=>!e.parent)),t.forEach((e=>e.children=z(e,s))),t.length?t:void 0}),[]),V=t.useCallback((e=>{const s=[];for(let t=0;t<e.length;t++){const o={...e[t]};o.children&&(o.children=V(o.children));const i={...o,key:o.id};s.push(i)}return s}),[]),G=(e,s)=>{F({modalShow:!0,nowData:e,operateType:s}),R(e&&e.id?D.filter((s=>{var t;const o=null==(t=s.menuAndPowers)?void 0:t.find((s=>s.menuId===e.menu));return!!o&&o.powers.includes(e.id)})).map((e=>e.id)):[]),setTimeout((()=>{"add"===s?O.resetFields():O.setFieldsValue({formConditions:null==e?void 0:e.conditions,formDesc:null==e?void 0:e.desc,formCode:null==e?void 0:e.code,formSorts:null==e?void 0:e.sorts,formTitle:null==e?void 0:e.title})}))},J=()=>{F({modalShow:!1})},Q=(e,s)=>{const t=D.map((t=>{const o=new Set(t.menuAndPowers.reduce(((e,s)=>[...e,...s.powers]),[]));return s.includes(t.id)?o.add(e):o.delete(e),{id:t.id,menus:t.menuAndPowers.map((e=>e.menuId)),powers:Array.from(o)}}));S.sys.setPowersByRoleIds(t)},H=t.useMemo((()=>{const e=o.cloneDeep(A.menus),s=V(e);return s.sort(((e,s)=>e.sorts-s.sorts)),z(null,s)||[]}),[A.menus,z]),K=[{title:"序号",dataIndex:"serial",key:"serial"},{title:"权限名称",dataIndex:"title",key:"title"},{title:"Code",dataIndex:"code",key:"code"},{title:"描述",dataIndex:"desc",key:"desc"},{title:"状态",dataIndex:"conditions",key:"conditions",render:e=>1===e?i.jsx("span",{style:{color:"green"},children:"启用"}):i.jsx("span",{style:{color:"red"},children:"禁用"})},{title:"操作",key:"control",width:120,render:(e,s)=>{const t=[];k.includes("power:query")&&t.push(i.jsx("span",{className:"control-btn green",onClick:()=>G(s,"see"),children:i.jsx(a,{placement:"top",title:"查看",children:i.jsx(w,{})})},"0")),k.includes("power:up")&&t.push(i.jsx("span",{className:"control-btn blue",onClick:()=>G(s,"up"),children:i.jsx(a,{placement:"top",title:"修改",children:i.jsx(g,{})})},"1")),k.includes("power:del")&&t.push(i.jsx(c,{title:"确定删除吗?",okText:"确定",cancelText:"取消",onConfirm:()=>(async e=>{const s={id:e.id};M(!0);const t=await S.sys.delPower(s);t&&200===t.status?(B(U.id),S.app.updateUserInfo(null),r.success("操作成功")):r.error((null==t?void 0:t.message)??"操作失败")})(s),children:i.jsx("span",{className:"control-btn red",children:i.jsx(a,{placement:"top",title:"删除",children:i.jsx(v,{})})})},"2"));const o=[];return t.forEach(((e,s)=>{s&&o.push(i.jsx(j,{type:"vertical"},`line${s}`)),o.push(e)})),o}}],W=t.useMemo((()=>P.map(((e,s)=>({key:s,id:e.id,menu:e.menu,title:e.title,code:e.code,desc:e.desc,sorts:e.sorts,conditions:e.conditions,serial:s+1,control:e.id})))),[P]),X=t.useMemo((()=>D.map((e=>({label:e.title,value:e.id})))),[D]);return i.jsxs("div",{className:"page-power-admin",children:[i.jsxs("div",{className:"l",children:[i.jsx("div",{className:"title",children:"目录结构"}),i.jsx("div",{children:i.jsx(l,{onSelect:(e,s)=>{s.selected?(B(e[0]),$({title:s.node.title,id:s.node.id})):($({}),N([]))},treeData:H})})]}),i.jsx("div",{className:"r",children:i.jsx(n,{className:"diy-table",columns:K,loading:q,dataSource:W,pagination:{showQuickJumper:!0,showTotal:e=>`共 ${e} 条数据`}})}),i.jsx(f,{title:`${{add:"新增",up:"修改",see:"查看"}[E.operateType]}权限: ${U.title}->${(null==(I=E.nowData)?void 0:I.title)??""}`,open:E.modalShow,onOk:async()=>{var e;if("see"!==E.operateType)try{const s=await O.validateFields(),t={title:s.formTitle,code:s.formCode,menu:U.id||0,sorts:s.formSorts,desc:s.formDesc,conditions:s.formConditions};if(F({modalLoading:!0}),"add"===E.operateType)try{const e=await S.sys.addPower(t);e&&200===e.status?(r.success("添加成功"),B(U.id),J(),await Q(e.data.id,L),S.app.updateUserInfo(null),S.sys.getAllRoles()):r.error("添加失败")}finally{F({modalLoading:!1})}else try{if(!(null==(e=null==E?void 0:E.nowData)?void 0:e.id))return void r.error("该数据没有ID");t.id=E.nowData.id;const s=await S.sys.upPower(t);s&&200===s.status?(r.success("修改成功"),B(U.id),J(),await Q(t.id,L),S.sys.getAllRoles(),S.app.updateUserInfo(null)):r.error("修改失败")}finally{F({modalLoading:!1})}}catch{}else J()},onCancel:J,confirmLoading:E.modalLoading,children:i.jsxs(p,{form:O,initialValues:{formConditions:1},children:[i.jsx(p.Item,{label:"权限名",name:"formTitle",...C,rules:[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}],children:i.jsx(m,{placeholder:"请输入权限名",disabled:"see"===E.operateType})}),i.jsx(p.Item,{label:"Code",name:"formCode",...C,rules:[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}],children:i.jsx(m,{placeholder:"请输入权限Code",disabled:"see"===E.operateType})}),i.jsx(p.Item,{label:"描述",name:"formDesc",...C,rules:[{max:100,message:"最多输入100位字符"}],children:i.jsx(T,{rows:4,disabled:"see"===E.operateType,autoSize:{minRows:2,maxRows:6}})}),i.jsx(p.Item,{label:"排序",name:"formSorts",...C,rules:[{required:!0,message:"请输入排序号"}],children:i.jsx(u,{min:0,max:99999,style:{width:"100%"},disabled:"see"===E.operateType})}),i.jsx(p.Item,{label:"状态",name:"formConditions",...C,rules:[{required:!0,message:"请选择状态"}],children:i.jsxs(y,{disabled:"see"===E.operateType,children:[i.jsx(b,{value:1,children:"启用"},1),i.jsx(b,{value:-1,children:"禁用"},-1)]})}),i.jsx(p.Item,{label:"赋予",...C,children:i.jsx(d.Group,{disabled:"see"===E.operateType,options:X,value:L,onChange:e=>R(e)})})]})})]})}export{I as default};
