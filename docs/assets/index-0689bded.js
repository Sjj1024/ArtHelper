import{r as e,A as t,_ as r,o as a,u as s,h as i,j as n,e as o,S as l,B as d,m as c,bK as u,bL as m}from"./index-efa3a32c.js";import{D as p}from"./index-1acfbbfd.js";import"./index-47693ae2.js";import{F as h}from"./index-ae2d5997.js";import{I as g}from"./index-8c8b720f.js";import{I as x}from"./index-06b8a89d.js";import{R as j}from"./index-9b8a3313.js";/* empty css              */import{T as v}from"./index-bf31a83e.js";/* empty css              */import{R as f}from"./index-8053d899.js";/* empty css                   */import{I as y}from"./antd-img-crop.esm-33921adc.js";import{s as w}from"./server-30e87f5b.js";import{T as b}from"./TextArea-09a4b200.js";import{u as I}from"./useSetState-78ffd672.js";import{U as S}from"./index-dff1ae8b.js";import{S as C}from"./index-1c1deade.js";import{C as N}from"./CloseOutlined-77969fe0.js";import"./CalendarOutlined-8ff6678f.js";import"./context-cb88fb1e.js";import"./statusUtils-b010cbea.js";import"./responsiveObserve-b13564d4.js";import"./index-177532f7.js";import"./EyeOutlined-319494bf.js";import"./SearchOutlined-03c63d28.js";import"./index-0a1440ec.js";import"./isEqual-8ee5b3ce.js";import"./index-46e73bcd.js";import"./ActionButton-e012fb99.js";import"./Portal-08554165.js";import"./getScrollBarSize-c6833c2b.js";import"./pickAttrs-1cd23dfa.js";import"./index-40784afc.js";import"./useForceUpdate-9ad39bdf.js";import"./DeleteOutlined-6b999003.js";import"./CheckOutlined-f0d55485.js";const L={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm192 472c0 4.4-3.6 8-8 8H544v152c0 4.4-3.6 8-8 8h-48c-4.4 0-8-3.6-8-8V544H328c-4.4 0-8-3.6-8-8v-48c0-4.4 3.6-8 8-8h152V328c0-4.4 3.6-8 8-8h48c4.4 0 8 3.6 8 8v152h152c4.4 0 8 3.6 8 8v48z"}}]},name:"plus-circle",theme:"filled"};var k=function(a,s){return e.createElement(t,r({},a,{ref:s,icon:L}))};const F=e.forwardRef(k);function D(){document.title="编辑服务";let[t,r]=a();const L=t.get("id"),k=t.get("model"),[D,R]=I(JSON.parse(localStorage.getItem("creatInfo")||"{}")),[T]=h.useForm(),q=s();document.title="1"===k?"新建服务":"编辑服务";const[$,Y]=I({id:8,uuid:"",prodname:"",capacity:100,currentcap:0,weighted:"",regtime:null,offtime:null,provideruuid:"",storeuuid:"",stationuuid:null,price:"",property:0,withcoach:0,status:0,addtime:"",updated:"",coachuuid:"",coachname:"",thumbpic:"",showingpic:"",prodintro:"",proddetail:"",refundruletype:"2",proportion:[{proportion:40,mintime:0,maxtime:24},{proportion:60,mintime:24,maxtime:72}],providername:"",storename:"",stationname:null}),O=e=>{var t;T.setFieldsValue({proxy:e.provideruuid,store:e.storeuuid,serveType:e.property,serverName:e.prodname,desc:e.prodintro,price:e.price,number:e.capacity,backRule:parseInt(e.refundruletype),weight:e.weighted,upDown:e.status,imageShow:e.thumbpic,imgList:e.showingpic,htmlDetail:e.proddetail,serveTime:e.regtime?2:1,linkField:e.stationuuid?2:1,trainCoach:e.withcoach}),J([{uid:"1",name:e.thumbpic,status:"done",url:e.thumbpic}]);const r=(null==(t=e.showingpic)?void 0:t.split(","))||[];W(r.map(((e,t)=>({uid:t,name:e,status:"done",url:e}))))},B=e.useMemo((()=>({toolbar:{container:[[{header:[1,2,3,4,5,!1]}],["bold","italic","underline","strike","blockquote","image"],[{list:"ordered"},{list:"bullet"},{color:[]},{background:[]},{align:[]}]]}})),[]),[M,E]=e.useState(""),P=e.useRef(null),[G,V]=e.useState(""),[z,H]=e.useState(0);e.useEffect((()=>{var e;const t=null==(e=null==P?void 0:P.current)?void 0:e.getEditor();t&&"api"===G&&0!==z&&t.setSelection(z+1)}),[M]);const[_,A]=e.useState([0]),[U,J]=e.useState([]),[K,W]=e.useState([]),X=e=>new Promise(((t,r)=>{const a=new FileReader;a.onload=e=>{const a=new Image;a.onload=function(){const{width:e,height:r}=this;t(750===e&&420===r)},a.onerror=r,a.src=e.target.result},a.onerror=r,a.readAsDataURL(e)})),[Q,Z]=e.useState(1),[ee,te]=I({date:i().format("YYYY-MM-DD"),start:i().format("YYYY-MM-DD HH:mm"),end:i().format("YYYY-MM-DD HH:mm")}),[re,ae]=e.useState(""),[se,ie]=e.useState([]),ne=async e=>{const t=await w.getPlaygroundList({provideruuid:e||D.store.value});if(200===t.code){const e=t.data.map((e=>({value:e.uuid,label:e.stationname})));ie(e)}else c.error(t.msg)},[oe,le]=e.useState([]),[de,ce]=e.useState(""),ue=async e=>{const t=await w.getTrainList({provideruuid:e||D.store.value});if(200===t.code){const e=t.data.map((e=>({value:e.uuid,label:e.coachname})));le(e)}else c.error(t.msg)},me=e=>String(e).replace(/^(\-)*(\d+)\.(\d\d).*$/,"$1$2.$3");return e.useEffect((()=>{L?(async()=>{const e={produuid:L},t=await w.getServeDetail(e);if(200===t.code){if(Y(t.data),R({proxy:{label:t.data.providername,value:t.data.provideruuid},store:{label:t.data.storename,value:t.data.storeuuid},type:t.data.property}),O(t.data),ne(t.data.storeuuid),ue(t.data.storeuuid),t.data.regtime){const e=t.data.regtime.split(" ")[0],r=t.data.regtime,a=t.data.offtime;te({date:e,start:r,end:a}),Z(2)}if(t.data.stationuuid&&ae(t.data.stationuuid),t.data.coachuuid&&ce(t.data.coachuuid),t.data.proportion&&t.data.proportion.length>0){let e=[];const r=t.data.proportion.map(((t,r)=>(e.push(t.mintime),{first:t.proportion,second:t.maxtime})));e.push(r[r.length-1].second),A(e),T.setFieldsValue({ruleList:r})}}else c.error(t.msg)})():(ne(),ue(),Y({providername:D.proxy.label,storename:D.store.label,property:D.type}),T.setFieldsValue({proxy:D.proxy.value,store:D.proxy.value,serveType:D.type}))}),[]),n.jsx("div",{className:"DetailBox",children:n.jsxs(h,{name:"serveBase",form:T,labelCol:{span:2},wrapperCol:{span:16},style:{minWidth:600},initialValues:{ruleList:[{}]},onFinish:async e=>{try{const e=await T.validateFields(),t={provideruuid:D.proxy.value,storeuuid:D.store.value,property:2,prodname:e.serverName,thumbpic:e.imageShow,regtime:"",offtime:"",stationuuid:"",showingpic:e.imgList,prodintro:e.desc,price:e.price,capacity:e.number,proddetail:e.htmlDetail,refundruletype:e.backRule,proportion:"",withcoach:e.trainCoach,coachuuid:"",status:e.upDown,weighted:e.weight};200===(await w.createServe(t)).code&&c.success("创建成功")}catch(t){}},labelAlign:"right",onFinishFailed:e=>{},autoComplete:"off",children:[n.jsx(h.Item,{label:"所属代理",name:"proxy",rules:[{required:!0,message:"请选择所属代理"}],children:n.jsx("span",{children:$.providername})}),n.jsx(h.Item,{label:"所属门店",name:"store",rules:[{required:!0,message:"请选择所属门店"}],children:n.jsx("span",{children:$.storename})}),n.jsx(h.Item,{label:"服务类型",name:"serveType",rules:[{required:!0,message:"请选择服务类型"}],children:n.jsx("span",{children:{0:"拼场",2:"活动",3:"课程"}[D.type||$.property]})}),n.jsx(h.Item,{label:"服务名称",name:"serverName",rules:[{required:!0,message:"请填写服务名称"}],children:n.jsx(g,{placeholder:"请输入服务名称",value:$.prodname})}),0!==D.type&&n.jsx(h.Item,{label:"服务小图",name:"imageShow",rules:[{required:!0,message:"请选择服务小图"}],children:n.jsx(y,{rotationSlider:!0,children:n.jsx(S,{action:`${o}/service_api/file_upload`,accept:"image/*",fileList:U,maxCount:1,beforeUpload:e=>{if(e.size>5242880)return c.error("图片尺寸不符合要求，请重新上传"),S.LIST_IGNORE;const t="image/png"===e.type||"image/jpeg"===e.type||"image/bmp"===e.type;return t||S.LIST_IGNORE},onChange:({file:e,fileList:t})=>{if("uploading"!==e.status){const e=null==t?void 0:t.map((e=>{var t;return e.response?null==(t=null==e?void 0:e.response)?void 0:t.data[0]:e.url})).join(",");T.setFieldsValue({imageShow:e})}J(t)},onPreview:async e=>{let t=e.url;t||(t=await new Promise((t=>{const r=new FileReader;r.readAsDataURL(e.originFileObj),r.onload=()=>t(r.result)})));const r=new Image;r.src=t;const a=window.open(t);null==a||a.document.write(r.outerHTML)},children:n.jsxs("div",{className:"uploadBox",children:[n.jsx("span",{className:"uploadBtn",children:"点击上传"}),n.jsx("span",{className:"uploadTips",onClick:e=>{e.stopPropagation()},children:"最多可上传1份，大小不超过5M，尺寸1:1，格式：jpg/png/bmp"})]})})})}),n.jsx(h.Item,{label:"服务时间",name:"serveTime",rules:[{required:!0,message:"请填写服务时间"},{validator:async(e,t)=>t?Promise.resolve():Promise.reject(new Error(""))}],children:n.jsx(j.Group,{onChange:e=>{Z(e.target.value)},children:n.jsxs(l,{direction:"vertical",children:[0!==D.type&&n.jsx(j,{value:1,children:"时间不限"}),n.jsxs(j,{value:2,children:[n.jsx("span",{children:"固定时间"}),n.jsx(p,{className:"serverTime",value:ee.date&&i(ee.date),onChange:(e,t)=>{if(e){const e=`${t} ${ee.start.split(" ")[1]}`,r=`${t} ${ee.end.split(" ")[1]}`;te({date:t,start:e,end:r})}else te({date:null})},format:"YYYY-MM-DD"}),n.jsx(v.RangePicker,{format:"HH",value:ee.start&&[i(ee.start),i(ee.end)],onChange:(e,t)=>{te(e?{start:`${ee.date} ${t[0]}:00:00`,end:`${ee.date} ${t[1]}:00:00`}:{start:null,end:null})}})]})]})})}),n.jsx(h.Item,{label:"关联场地",name:"linkField",rules:[{required:!0,message:"请选择关联场地"}],children:n.jsx(j.Group,{children:n.jsxs(l,{direction:"horizontal",children:[n.jsx(j,{value:1,children:"不关联"}),n.jsx(j,{value:2,children:n.jsx("span",{className:"linkField",children:"关联"})}),n.jsx(C,{style:{width:160},onChange:e=>{ae(e)},value:re,options:se})]})})}),0!==D.type&&n.jsx(h.Item,{label:"轮播图",name:"imgList",rules:[{required:!0,message:"请上传轮播图"}],children:n.jsx(n.Fragment,{children:n.jsx(S,{action:`${o}/service_api/file_upload`,accept:"image/*",fileList:K,maxCount:3,beforeUpload:async e=>{if(e.size>10485760)return c.error("图片尺寸不符合要求，请重新上传"),S.LIST_IGNORE;const t=await X(e);return t||c.error("图片尺寸不符合要求，请重新上传"),t||S.LIST_IGNORE},onChange:({file:e,fileList:t})=>{if("uploading"!==e.status){const e=null==t?void 0:t.map((e=>{var t;return e.response?null==(t=null==e?void 0:e.response)?void 0:t.data[0]:e.url})).join(",");T.setFieldsValue({imgList:e})}W(t)},children:U.length<5&&n.jsxs("div",{className:"uploadBox",children:[n.jsx("span",{className:"uploadBtn",children:"点击上传"}),n.jsx("span",{className:"uploadTips",onClick:e=>{e.stopPropagation()},children:"最多3张，单张图片不超过10MB，尺寸750*420px，支持jpg/png/bmp格式"})]})})})}),0!==D.type&&n.jsx(h.Item,{label:"服务介绍",name:"desc",rules:[{required:!0,message:"请输入服务介绍"}],children:n.jsx(b,{rows:4,placeholder:"请输入服务介绍",maxLength:100})}),n.jsx(h.Item,{label:"服务价格",name:"price",rules:[{required:!0,message:"请输入服务价格"}],children:n.jsx(x,{placeholder:"请输入服务价格",className:"inputNumber",formatter:me,parser:me})}),n.jsx(h.Item,{label:"服务名额",name:"number",rules:[{required:!0,message:"请输入服务名额"}],children:n.jsx(x,{placeholder:"请输入服务名额",className:"inputNumber"})}),0!==D.type&&n.jsx(h.Item,{label:"图文详情",name:"htmlDetail",rules:[{required:!0,message:"请输入图文详情"}],children:n.jsx(f,{theme:"snow",ref:P,value:M,modules:B,placeholder:"请输入图文详情",onChange:(e,t,r,a)=>{var s;let i=null==(s=null==P?void 0:P.current)?void 0:s.getEditor();i.focus();let n=t.ops,o=a.getContents();E(e);const l=i.getSelection();if(l)if(0==l.length&&0!==l.index)H(l.index);else{i.getText(l.index,l.length)}V(r),n&&n.length>0&&o.ops.map((e=>{if(e.insert){let t=e.insert.image;if(t&&(null==t?void 0:t.includes("data:image/"))){let r=u(t);if(r.size>5242880)return c.error("文件过大，上传失败"),e.insert.image="",void i.setContents(o);{let t=new FormData;t.append("file",r),m(t).then((t=>{e.insert.image=t.data[0],i.setContents(o)}))}}}}))}})}),n.jsx(h.Item,{label:"退款规则",name:"backRule",rules:[{required:!0,message:"请选择退款规则"}],children:n.jsx(j.Group,{children:n.jsxs(l,{direction:"vertical",children:[n.jsxs("div",{children:[n.jsx(j,{value:0,children:"免费取消"}),n.jsx(j,{value:1,children:"不可取消"})]}),n.jsxs(j,{value:2,children:[n.jsx("div",{className:"cancelTips",children:"按比例取消（超过最大时间按免费取消算）"}),n.jsx(h.List,{name:["ruleList"],children:(e,t)=>n.jsx("div",{style:{display:"flex",flexDirection:"column",rowGap:16},children:e.map(((e,r)=>n.jsxs(l,{children:[n.jsxs("div",{className:"cancelBox",children:[n.jsxs("div",{className:"rateLabel",children:["比例",r+1]}),n.jsx(h.Item,{noStyle:!0,name:[e.name,"first"],children:n.jsx(g,{addonAfter:"%",className:"rateInput"})}),n.jsx(g,{value:_[r],disabled:!0,className:"firstInput"}),n.jsx("div",{className:"middle",children:"小时———"}),n.jsx(h.Item,{noStyle:!0,name:[e.name,"second"],children:n.jsx(g,{onChange:e=>((e,t)=>{let r=[..._];r[e+1]=t,A(r)})(r,e.target.value),className:"secondInput"})}),n.jsxs("div",{className:"middle",children:[n.jsx("span",{className:"hour",children:"小时"}),0===r&&n.jsx(F,{className:"addIcon",onClick:()=>{t.add()}})]})]}),0!==r&&n.jsx(N,{onClick:()=>{t.remove(e.name)}})]},e.key)))})})]})]})})}),n.jsx(h.Item,{label:"活动教练",name:"trainCoach",rules:[{required:!0,message:"请选择活动教练"}],children:n.jsx(j.Group,{onChange:()=>{},children:n.jsxs(l,{direction:"horizontal",children:[n.jsx(j,{value:0,children:"现场分配"}),n.jsx(j,{value:1,children:"不含教练"}),n.jsx(j,{value:2,children:"指定教练"}),n.jsx(C,{style:{width:120},onChange:e=>{ce(e)},value:de,options:oe})]})})}),n.jsx(h.Item,{label:"服务上架",name:"upDown",rules:[{required:!0,message:"请选择服务上架"}],children:n.jsx(j.Group,{onChange:e=>{},children:n.jsxs(l,{direction:"horizontal",children:[n.jsx(j,{value:0,children:"上架"}),n.jsx(j,{value:1,children:"下架"})]})})}),0!==D.type&&n.jsx(h.Item,{label:"权重值",name:"weight",rules:[{required:!0,message:"请填写权重值"}],children:n.jsxs(n.Fragment,{children:[n.jsx(g,{value:$.weighted,className:"wightInput",onChange:e=>{Y({weighted:e.target.value}),T.setFieldsValue({weight:e.target.value})}}),n.jsx("span",{children:"(1~999，权重值越高展示越前面)"})]})}),n.jsxs(h.Item,{wrapperCol:{offset:5,span:16},children:[n.jsx(d,{type:"primary",className:"submitBtn",onClick:async()=>{try{const e=await T.validateFields();"1"===k?(async e=>{let t="",r="";2===Q&&(t=`${ee.start}`,r=`${ee.end}`);let a="";2===e.linkField&&(a=re);let s=[];if(2===e.backRule){let t=0;s=e.ruleList.map((e=>{const r={proportion:parseInt(e.first),mintime:t,maxtime:parseInt(e.second)};return t=parseInt(e.second),r}))}let i="";2===e.trainCoach&&(i=de);const n={provideruuid:D.proxy.value,storeuuid:D.store.value,property:D.type,prodname:e.serverName,thumbpic:e.imageShow,regtime:t,offtime:r,stationuuid:a,showingpic:e.imgList,prodintro:e.desc,price:e.price,capacity:e.number,proddetail:M||$.proddetail,refundruletype:e.backRule,proportion:JSON.stringify(s),withcoach:e.trainCoach,coachuuid:i,status:e.upDown,weighted:e.weight},o=await w.createServe(n);200===o.code?(c.success("创建成功"),q("/store/run/serve")):c.error(o.msg)})(e):"2"===k&&(async e=>{let t="",r="";2===Q&&(t=`${ee.start}`,r=`${ee.end}`);let a="";2===e.linkField&&(a=re);let s=[];if(2===e.backRule){let t=0;s=e.ruleList.map((e=>{const r={proportion:parseInt(e.first),mintime:t,maxtime:parseInt(e.second)};return t=parseInt(e.second),r}))}let i="";2===e.trainCoach&&(i=de);const n={produuid:L,provideruuid:$.provideruuid,storeuuid:$.storeuuid,property:$.property,prodname:e.serverName||$.prodname,thumbpic:e.imageShow,regtime:t,offtime:r,stationuuid:a,showingpic:e.imgList,prodintro:e.desc,price:e.price,capacity:e.number,proddetail:M||$.proddetail,refundruletype:e.backRule,proportion:JSON.stringify(s),withcoach:e.trainCoach,coachuuid:i,status:e.upDown,weighted:e.weight},o=await w.updateServe(n);200===o.code?(c.success("编辑成功"),q("/store/run/serve")):c.error(o.msg)})(e)}catch(e){}},children:"提交"}),n.jsx(d,{className:"callbackBtn",onClick:()=>q(-1),children:"返回"})]})]})})}export{D as default};
