import{d as e,r as s,j as t,B as a,h as r,m as i,e as o}from"./index-efa3a32c.js";import{F as l}from"./index-ae2d5997.js";import{I as d}from"./index-8c8b720f.js";import{a as n}from"./index-639ffc53.js";import"./index-0373e759.js";/* empty css              */import"./index-9b480cfe.js";import"./index-9b8a3313.js";import{P as m}from"./index-94ed3db3.js";import{D as p}from"./index-65748fb5.js";import{D as u}from"./index-1acfbbfd.js";import"./index-47693ae2.js";/* empty css              */import{I as c}from"./index-9bf69a37.js";import{a as h}from"./app-4adb5e72.js";import{u as x}from"./useSetState-78ffd672.js";import{M as j}from"./index-46e73bcd.js";import{S as g}from"./index-1c1deade.js";import{U as y}from"./index-dff1ae8b.js";import{P as f}from"./PlusCircleOutlined-176a31dc.js";import"./context-cb88fb1e.js";import"./responsiveObserve-b13564d4.js";import"./index-177532f7.js";import"./statusUtils-b010cbea.js";import"./EyeOutlined-319494bf.js";import"./SearchOutlined-03c63d28.js";import"./pickAttrs-1cd23dfa.js";import"./index-40784afc.js";import"./getScrollBarSize-c6833c2b.js";import"./isEqual-8ee5b3ce.js";import"./useForceUpdate-9ad39bdf.js";import"./index-0a1440ec.js";import"./ActionButton-e012fb99.js";import"./CalendarOutlined-8ff6678f.js";import"./Portal-08554165.js";import"./CheckOutlined-f0d55485.js";import"./DeleteOutlined-6b999003.js";function v(){document.title="分享页管理";const v=e((e=>e.app.powersCode)),[C]=l.useForm(),[T,I]=s.useState([]),[S,w]=s.useState(!1),[b,k]=x({pageNum:1,pageSize:10,total:0}),[Y,D]=x({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1}),M={shareName:"",relatedCard:void 0,posterImg:null,startTime:"",endTime:"",shareTitle:"",shareCover:null},N=(e,s)=>{if(D({operateType:s,nowData:e,modalShow:!0,modalLoading:!1}),e){const s={uid:Date.now(),name:"image.png",status:"done",url:e.posterImg};O([s]);const t={uid:Date.now(),name:"image.png",status:"done",url:e.shareCover};E([t]),C.setFieldsValue({shareName:e.shareName,relatedCard:e.relatedCardId,posterImg:e.posterImg,startTime:r(e.startTime),endTime:r(e.endTime),shareTitle:e.shareTitle,shareCover:e.shareCover})}else C.setFieldsValue({...M})},L=()=>{C.setFieldsValue({...M}),D({modalShow:!1}),O([]),E([])},z=async e=>{const s={page:e.pageNum,limit:e.pageSize,status:null};w(!0);try{const t=await h.shareList(s);t&&200===t.code?(I(t.data),k({total:t.count,pageNum:e.pageNum,pageSize:e.pageSize})):i.error((null==t?void 0:t.message)??"获取失败")}finally{w(!1)}},[H,q]=s.useState([]),[F,O]=s.useState([]),B={accept:".jpg,.png,",action:`${o}/service_api/file_upload`,beforeUpload(e){const s=e.size/1024/1024<5;if(s)return s;i.error("文件大小必须小于 5MB!")},onChange({file:e,fileList:s}){O(s),"error"===e.status?O([]):"done"===e.status&&O(s)},fileList:F,maxCount:1},[V,E]=s.useState([]),P={accept:".jpg,.png,",action:`${o}/service_api/file_upload`,beforeUpload(e){const s=e.size/1024/1024<1;if(s)return s;i.error("文件大小必须小于 1MB!")},onChange({file:e,fileList:s}){E(s),"error"===e.status?E([]):"done"===e.status&&E(s)},fileList:V,maxCount:1},U=[{title:"id",dataIndex:"id",key:"id"},{title:"分享页标题",dataIndex:"shareName",key:"shareName"},{title:"活动海报图",dataIndex:"posterImg",key:"posterImg",render:(e,s)=>t.jsx("span",{style:{color:" rgb( 66,149,229)",cursor:"pointer"},onClick:()=>Q(s),children:"点击查看"})},{title:"关联卡券",dataIndex:"relatedCard",key:"relatedCard",width:"300px"},{title:"分享标题",dataIndex:"shareTitle",key:"shareTitle"},{title:"分享封面图",dataIndex:"shareCover",key:"shareCover",render:(e,s)=>t.jsx("span",{style:{color:" rgb( 66,149,229)",cursor:"pointer"},onClick:()=>Z(s),children:"点击查看"})},{title:"活动开始时间",dataIndex:"startTime",key:"startTime"},{title:"活动结束时间",dataIndex:"endTime",key:"endTime"},{title:"状态",dataIndex:"status",key:"status",render:e=>1===e?"上架":"下架"},{title:"创建者",dataIndex:"creator",key:"creator"},{title:"创建时间",dataIndex:"createTime",key:"createTime"},{title:"操作",key:"control",render:(e,s)=>{const a=[];v.includes("share:edit")&&a.push(t.jsx("span",{style:{color:" rgb( 66,149,229)",cursor:"pointer"},onClick:()=>N(s,"edit"),children:"编辑"},"1")),v.includes("share:upAndDown")&&a.push(t.jsx(m,{title:1===s.status?"确定设置为下架吗？":"确定设置为上架吗？",onConfirm:()=>{(async e=>{const s={uuid:e.uuid,status:1===e.status?0:1},t=await h.shareStatus(s);t&&200===t.code?(i.success("操作成功"),z(b)):i.error((null==t?void 0:t.message)??"操作失败")})(s)},okText:"确定",cancelText:"取消",children:t.jsx("span",{style:{color:" rgb( 66,149,229)",cursor:"pointer"},children:1===s.status?"下架":"上架"})},"2")),v.includes("share:copy")&&a.push(t.jsx("span",{style:{color:" rgb( 66,149,229)",cursor:"pointer"},onClick:()=>(e=>{let s=document.createElement("textarea");return s.value=e.posturl,s.style.position="absolute",s.style.opacity="0",s.style.left="-999999px",s.style.top="-999999px",document.body.appendChild(s),s.focus(),s.select(),new Promise(((e,t)=>{document.execCommand("copy"),i.success("复制成功"),s.remove()}))})(s),children:"复制链接"},"3"));const r=[];return a.forEach(((e,s)=>{s&&r.push(t.jsx(p,{type:"vertical"},`line${s}`)),r.push(e)})),r}}],$=s.useMemo((()=>T.map(((e,s)=>({key:e.uuid,uuid:e.uuid,serial:s+1+(b.pageNum-1)*b.pageSize,id:e.id,shareName:e.posttitle,posterImg:e.postpicurl,relatedCard:e.courtesyname,relatedCardId:e.courtesyuuid,shareTitle:e.postsharedtitle,shareCover:e.postsharepicurl,startTime:e.poststarttime,endTime:e.postendtime,status:e.status,creator:e.user_name,createTime:e.addtime,posturl:e.posturl})))),[b,T]),[_,A]=s.useState(!1),[J,K]=s.useState(""),Q=e=>{A(!0),K(e.posterImg)},[G,R]=s.useState(!1),[W,X]=s.useState(""),Z=e=>{R(!0),X(e.shareCover)};return s.useEffect((()=>{z(b),(async()=>{const e=await h.cardSelect();e&&200===e.code&&q(e.data.map((e=>({label:e.courtesyname,value:e.uuid}))))})()}),[]),t.jsxs("div",{children:[t.jsx("div",{children:t.jsx("ul",{style:{textAlign:"right"},children:v.includes("share:add")&&t.jsx("li",{children:t.jsx(a,{type:"primary",icon:t.jsx(f,{}),disabled:!v.includes("share:add"),onClick:()=>N(null,"add"),children:"新建分享页"})})})}),t.jsx("div",{children:t.jsx(n,{columns:U,loading:S,dataSource:$,rowKey:e=>e.id,pagination:{total:b.total,current:b.pageNum,pageSize:b.pageSize,showQuickJumper:!1,showTotal:e=>`共 ${e} 条数据`,onChange:(e,s)=>((e,s)=>{z({pageNum:e,pageSize:s||b.pageSize})})(e,s)}})}),t.jsx(j,{title:{add:"创建卡券",edit:"编辑卡券"}[Y.operateType],open:Y.modalShow,cancelText:"取消",okText:"确认",onOk:async e=>{var s,t,a,r,o,l,d,n,m,p,u,c,x,j,g,y,f,v;D({modalLoading:!0});try{const e=await C.validateFields();if("add"===Y.operateType){const d={posttitle:e.shareName,courtesyuuid:e.relatedCard,postpicurl:null==(a=null==(t=null==(s=e.posterImg)?void 0:s.file)?void 0:t.response)?void 0:a.data[0],poststarttime:e.startTime.format("YYYY-MM-DD HH:mm:ss"),postendtime:e.endTime.format("YYYY-MM-DD HH:mm:ss"),postsharedtitle:e.shareTitle,postsharepicurl:null==(l=null==(o=null==(r=e.shareCover)?void 0:r.file)?void 0:o.response)?void 0:l.data[0]},n=await h.addShare(d);n&&200===n.code?(i.success("添加成功"),L(),z(b)):i.error((null==n?void 0:n.message)??"添加失败")}else if("edit"===Y.operateType){const s={uuid:Y.nowData.uuid,posttitle:e.shareName,courtesyuuid:e.relatedCard,postpicurl:(null==(m=null==(n=null==(d=e.posterImg)?void 0:d.file)?void 0:n.response)?void 0:m.data[0])?null==(c=null==(u=null==(p=e.posterImg)?void 0:p.file)?void 0:u.response)?void 0:c.data[0]:e.posterImg,poststarttime:e.startTime.format("YYYY-MM-DD HH:mm:ss"),postendtime:e.endTime.format("YYYY-MM-DD HH:mm:ss"),postsharedtitle:e.shareTitle,postsharepicurl:(null==(g=null==(j=null==(x=e.shareCover)?void 0:x.file)?void 0:j.response)?void 0:g.data[0])?null==(v=null==(f=null==(y=e.shareCover)?void 0:y.file)?void 0:f.response)?void 0:v.data[0]:e.shareCover},t=await h.editShare(s);t&&200===t.code?(i.success("修改成功"),L(),z(b)):i.error((null==t?void 0:t.message)??"修改失败")}}finally{D({modalLoading:!1})}},onCancel:()=>L(),confirmLoading:Y.modalLoading,children:t.jsxs(l,{form:C,initialValues:{formConditions:1},labelCol:{span:6},children:[t.jsx(l.Item,{label:"分享页标题",name:"shareName",rules:[{required:!0,whitespace:!0,message:"请输入分享页标题"},{max:40,message:"最多输入40位字符"}],children:t.jsx(d,{style:{width:"300px"},placeholder:"请输入"})}),t.jsx(l.Item,{name:"relatedCard",label:"关联卡券",rules:[{required:!0,message:"请选择关联卡券"}],children:t.jsx(g,{style:{width:"300px"},placeholder:"请选择",allowClear:!0,options:H})}),t.jsx(l.Item,{name:"posterImg",label:"海报图",rules:[{required:!0,message:"请上传海报图"}],children:t.jsxs(y,{...B,children:[t.jsx(a,{children:"上传文件"}),t.jsx("span",{style:{marginLeft:10},children:"jpg/png，大小不超过5MB"})]})}),t.jsx(l.Item,{name:"startTime",label:"活动开始时间",rules:[{required:!0,message:"请选择"}],children:t.jsx(u,{format:"YYYY-MM-DD HH:mm:ss",style:{width:"300px"}})}),t.jsx(l.Item,{name:"endTime",label:"活动结束时间",rules:[{required:!0,message:"请选择"}],children:t.jsx(u,{format:"YYYY-MM-DD HH:mm:ss",style:{width:"300px"}})}),t.jsx(l.Item,{label:"分享标题",name:"shareTitle",rules:[{max:40,message:"最多输入40个字符"},{required:!0,message:"请输入分享标题"}],children:t.jsx(d,{style:{width:"300px"},placeholder:"请输入"})}),t.jsx(l.Item,{name:"shareCover",label:"分享图",rules:[{required:!0,message:"请上传分享图"}],children:t.jsxs(y,{...P,children:[t.jsx(a,{children:"上传文件"}),t.jsx("span",{style:{marginLeft:10},children:"jpg/png，大小不超过1MB"})]})})]})}),t.jsx(c,{style:{display:"none"},src:J,preview:{visible:_,onVisibleChange:e=>{A(e)}}}),t.jsx(c,{style:{display:"none"},src:W,preview:{visible:G,onVisibleChange:e=>{R(e)}}})]})}export{v as default};
