import{r as e,l as s,j as a,a as r,d as o,B as t,t as l,m as i,T as n}from"./index-efa3a32c.js";import{F as d}from"./index-ae2d5997.js";import{I as u}from"./index-8c8b720f.js";import{T as c,a as p}from"./index-639ffc53.js";import"./index-0373e759.js";/* empty css              */import"./index-9b480cfe.js";import"./index-9b8a3313.js";import{P as m}from"./index-94ed3db3.js";import{D as x}from"./index-65748fb5.js";import{M as h}from"./index-46e73bcd.js";import{u as j}from"./user-66ba9e41.js";import{u as g}from"./useSetState-78ffd672.js";import{u as y}from"./useMount-5c373398.js";import{S as v}from"./index-1c1deade.js";import{P as f}from"./PlusCircleOutlined-176a31dc.js";import{E as b}from"./EditOutlined-e081177a.js";import{S,C as k}from"./StopOutlined-b809cae3.js";import"./context-cb88fb1e.js";import"./responsiveObserve-b13564d4.js";import"./index-177532f7.js";import"./statusUtils-b010cbea.js";import"./EyeOutlined-319494bf.js";import"./SearchOutlined-03c63d28.js";import"./pickAttrs-1cd23dfa.js";import"./index-40784afc.js";import"./getScrollBarSize-c6833c2b.js";import"./isEqual-8ee5b3ce.js";import"./useForceUpdate-9ad39bdf.js";import"./index-0a1440ec.js";import"./ActionButton-e012fb99.js";import"./Portal-08554165.js";import"./CheckOutlined-f0d55485.js";function w(r){const[o,t]=e.useState([]);e.useEffect((()=>{t(r.defaultKeys.map((e=>`${e}`)))}),[r.defaultKeys]);const l=e.useCallback(((e,s)=>{let a;return a=e?s.filter((s=>{var a;return(null==(a=s.parent)?void 0:a.id)===e.id})):s.filter((e=>!e.parent)),a.forEach((e=>e.children=l(e,s))),a.length?a:void 0}),[]),i=e.useCallback((()=>{const e=r.data.filter((e=>o.includes(`${e.id}`)));r.onOk&&r.onOk(o,e)}),[r,o]),n=e.useCallback((()=>{r.onClose()}),[r]),d=e.useCallback((e=>{t(e)}),[]),u=e.useCallback((e=>{const s=[];for(let a=0;a<e.length;a++){const r={...e[a]};r.children&&(r.children=u(r.children));const o={...r,key:r.id};s.push(o)}return s}),[]),p=e.useMemo((()=>{const e=s.cloneDeep(r.data),a=u(e);return a.forEach((e=>{e.key=String(e.id)})),l(void 0,a)||[]}),[r.data,l]);return a.jsx(h,{title:r.title||"请选择",open:r.visible,wrapClassName:"menuTreeModal",confirmLoading:r.loading,onOk:i,onCancel:n,children:a.jsx(c,{checkable:!0,selectable:!1,checkedKeys:o,onCheck:d,treeData:p})})}const T={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:19}}};function I(){document.title="用户管理";const s=r(),c=o((e=>e.app.userinfo)),I=o((e=>e.app.powersCode)),[C]=d.useForm(),[N,L]=e.useState([]),[O,D]=e.useState(!1),[z,P]=g({pageNum:1,pageSize:10,total:0}),[E,F]=g({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1}),[U,q]=e.useState([]),[B,M]=e.useState(0),[V,$]=e.useState([]),[A,K]=e.useState([]),R=async e=>{W(""),C.setFieldsValue({store:""});const s=(await j.getStores({agenuuid:e})).data.map((e=>({label:e.providername,value:e.uuid})));K(s)};g({username:void 0,conditions:void 0});const[J,Q]=g({roleData:[],roleTreeLoading:!1,roleTreeShow:!1,roleTreeDefault:[]}),[G,H]=e.useState([]),W=async e=>{try{const s=await j.getRoles({provideruuid:"-"===e?"":e});if(s&&200===s.code){const e=s.data.map((e=>({label:e.rolename,value:e.uuid})));H(e)}}catch{}};async function X(e){const s={page:e.pageNum,limit:e.pageSize};D(!0);try{const a=await j.getUsers(s);a&&200===a.code?(L(a.data),P({pageNum:e.pageNum,pageSize:e.pageSize,total:a.cont})):i.error((null==a?void 0:a.message)??"数据获取失败")}finally{D(!1)}}const[Y,Z]=e.useState(""),_={username:"",password:"",email:"",phone:"",agent:"",store:"",role:""},ee=(e,s)=>{F({modalShow:!0,nowData:e,operateType:s}),setTimeout((()=>{W(""),"add"===s?C.setFieldsValue({..._}):e&&(e.proxyId&&R(e.proxyId),e.storeId&&W(e.storeId),Z(e.uuid),C.setFieldsValue({...e,role:"-"===e.role?"":e.role,store:"-"===e.storeId?"":e.storeId,agent:"-"===e.proxyId?"":e.proxyId,userlevel:"-"===e.userlevel?"":e.userlevel}),M(e.userlevel))}))},se=()=>{C.setFieldsValue({..._}),F({modalShow:!1})},ae=()=>{Q({roleTreeShow:!1})},re=[{title:"编号",dataIndex:"serial",key:"serial"},{title:"用户名",dataIndex:"username",key:"username"},{title:"所属门店",dataIndex:"store",key:"store"},{title:"所属代理",dataIndex:"proxy",key:"proxy"},{title:"手机号",dataIndex:"phone",key:"phone"},{title:"邮箱",dataIndex:"email",key:"email"},{title:"所属角色",dataIndex:"role",key:"role"},{title:"状态",dataIndex:"conditions",key:"conditions",render:e=>1===e?a.jsx("span",{style:{color:"green"},children:"启用"}):a.jsx("span",{style:{color:"red"},children:"禁用"})},{title:"操作",key:"control",width:200,render:(e,s)=>{const r=[],o=c.userBasicInfo||{id:-1};I.includes("user:up")&&r.push(a.jsx("span",{className:"control-btn blue",onClick:()=>ee(s,"up"),children:a.jsx(n,{placement:"top",title:"编辑",children:a.jsx(b,{})})},"1")),I.includes("user:del")&&o.id!==s.id&&r.push(a.jsx(m,{title:1===s.status?"确定禁用吗？":"确定启用吗？",onConfirm:()=>(async e=>{D(!0);try{const s=await j.setUserState({uuid:e.uuid,status:1===e.status?0:1});s&&200===s.code?(i.success("操作成功"),X(z)):i.error((null==s?void 0:s.message)??"操作失败")}finally{D(!1)}})(s),okText:"确定",cancelText:"取消",children:a.jsx("span",{className:"control-btn red",children:a.jsx(n,{placement:"top",title:1===s.status?"禁用":"启用",children:1===s.status?a.jsx(S,{}):a.jsx(k,{style:{color:"green"}})})})},"3"));const t=[];return r.forEach(((e,s)=>{s&&t.push(a.jsx(x,{type:"vertical"},`line${s}`)),t.push(e)})),t}}],oe=e.useMemo((()=>N.map(((e,s)=>({key:s,id:e.id,uuid:e.uuid,serial:s+1+(z.pageNum-1)*z.pageSize,username:e.username,store:e.providerinfor?e.providerinfor.providername:"-",storeId:e.providerinfor?e.providerinfor.uuid:"-",proxy:e.providerinfor&&e.providerinfor.agentinfor?e.providerinfor.agentinfor.providername:"-",proxyId:e.providerinfor&&e.providerinfor.agentinfor?e.providerinfor.agentinfor.uuid:"-",email:e.emailaddr,phone:e.mob,conditions:e.status,status:e.status,control:e.id,userlevel:e.userlevel,role:e.rolelist?e.rolelist.rolename:"-"})))),[z,N]);return y((()=>{X(z),(async()=>{const e=(await j.getAgents()).data.map((e=>({label:e.providername,value:e.uuid})));$(e)})(),(async()=>{const e=await j.getUserTypes();if(200===e.code){const s=e.data.map((e=>({label:e.name,value:e.id})));q(s)}})()})),a.jsxs("div",{className:"user-box",children:[a.jsx("div",{className:"user-search",children:a.jsx("ul",{className:"search-func",children:I.includes("user:add")&&a.jsx("li",{children:a.jsx(t,{type:"primary",icon:a.jsx(f,{}),disabled:!I.includes("user:add"),onClick:()=>ee(null,"add"),children:"新增用户"})})})}),a.jsx("div",{className:"diy-table",children:a.jsx(p,{columns:re,loading:O,dataSource:oe,pagination:{total:z.total,current:z.pageNum,pageSize:z.pageSize,showQuickJumper:!1,showTotal:e=>`共 ${e} 条数据`,onChange:(e,s)=>{X({pageNum:e,pageSize:s})}}})}),a.jsx(h,{title:{add:"新增用户",up:"修改用户",see:"查看"}[E.operateType],open:E.modalShow,cancelText:"取消",okText:"提交",onOk:async()=>{var e,s;if("see"!==E.operateType)try{const a=await C.validateFields();F({modalLoading:!0});const r={username:a.username,mob:a.phone,emailaddr:a.email,hostprovider:a.store,roleid:a.role,userlevel:a.userlevel,agentuuid:a.agent};if("add"===E.operateType)try{const e=await j.addUser(r);e&&200===e.code?(i.success("添加成功"),X(z),se()):i.error((null==e?void 0:e.message)??"操作失败")}finally{F({modalLoading:!1})}else{const r=null==(e=A.find((e=>e.label===a.store||e.value===a.store)))?void 0:e.value,o=null==(s=G.find((e=>e.label===a.role||e.value===a.role)))?void 0:s.value,t={uuid:Y,username:a.username,mob:a.phone,email:a.email,hostprovider:r,roleid:o,userlevel:a.userlevel,agentuuid:a.agent};try{const e=await j.editUser(t);e&&200===e.code?(i.success("修改成功"),X(z),se()):i.error((null==e?void 0:e.message)??"操作失败")}finally{F({modalLoading:!1})}}}catch{}else se()},onCancel:se,confirmLoading:E.modalLoading,children:a.jsxs(d,{form:C,initialValues:{conditions:1},children:[a.jsx(d.Item,{label:"用户名",name:"username",...T,rules:[{required:!0,whitespace:!0,message:"请输入用户名"},{max:20,message:"最多输入20位字符"}],children:a.jsx(u,{placeholder:"请输入用户名",disabled:"see"===E.operateType})}),"sel"===E.operateType&&a.jsx(d.Item,{label:"密码",name:"password",...T,rules:[{required:!0,whitespace:!0,message:"请输入密码"},{min:6,message:"最少输入6位字符"},{max:18,message:"最多输入18位字符"}],children:a.jsx(u.Password,{placeholder:"请输入密码",disabled:"sel"===E.operateType})}),a.jsx(d.Item,{label:"用户类型",name:"userlevel",...T,rules:[{required:!0,message:"请选择用户类型"}],children:a.jsx(v,{disabled:"see"===E.operateType,options:U,onChange:e=>{M(e)}})}),a.jsx(d.Item,{label:"电话",name:"phone",...T,rules:[{required:!0,message:"请输入电话"},()=>({validator:(e,s)=>{const a=s;return a&&!l.checkPhone(a)?Promise.reject("请输入有效的手机号码"):Promise.resolve()}})],children:a.jsx(u,{placeholder:"请输入手机号",maxLength:11,disabled:"see"===E.operateType})}),a.jsx(d.Item,{label:"邮箱",name:"email",...T,rules:[()=>({validator:(e,s)=>{const a=s;return a&&!l.checkEmail(a)?Promise.reject("请输入有效的邮箱地址"):Promise.resolve()}})],children:a.jsx(u,{placeholder:"请输入邮箱地址",disabled:"see"===E.operateType})}),999!==B&&a.jsx(d.Item,{label:"代理",name:"agent",...T,rules:[{required:!0,message:"请选择代理"}],children:a.jsx(v,{disabled:"see"===E.operateType,options:V,onSelect:R})}),(50===B||51===B)&&a.jsx(d.Item,{label:"门店",name:"store",...T,rules:[{required:!0,message:"请选择门店"}],children:a.jsx(v,{disabled:"see"===E.operateType,options:A,onSelect:W})}),a.jsx(d.Item,{label:"角色",name:"role",...T,rules:[{message:"请选择角色"}],children:a.jsx(v,{disabled:"see"===E.operateType,options:G})})]})}),a.jsx(w,{title:"分配角色",data:J.roleData,visible:J.roleTreeShow,defaultKeys:J.roleTreeDefault,loading:J.roleTreeLoading,onOk:async e=>{var a;if(!(null==(a=E.nowData)?void 0:a.id))return void i.error("未获取到该条数据id");const r={id:E.nowData.id,roles:e.map((e=>Number(e)))};Q({roleTreeLoading:!0});try{const e=await s.sys.setUserRoles(r);e&&200===e.status?(i.success("分配成功"),X(z),ae()):i.error((null==e?void 0:e.message)??"操作失败")}finally{Q({roleTreeLoading:!1})}},onClose:ae})]})}export{I as default};
