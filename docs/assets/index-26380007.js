import{a as e,d as s,r as a,b as o,m as t,j as i,B as r,T as l}from"./index-efa3a32c.js";import{F as n}from"./index-ae2d5997.js";import{I as d}from"./index-8c8b720f.js";import{a as u}from"./index-639ffc53.js";import"./index-0373e759.js";/* empty css              */import"./index-9b480cfe.js";import"./index-9b8a3313.js";import{P as m}from"./index-94ed3db3.js";import{D as p}from"./index-65748fb5.js";import{I as c}from"./index-06b8a89d.js";import{u as x}from"./user-66ba9e41.js";import{T as j}from"./PowerTreeTable-a796c563.js";import{u as h}from"./useSetState-78ffd672.js";import{S as w}from"./index-1c1deade.js";import{M as y}from"./index-46e73bcd.js";import{S as g}from"./SearchOutlined-24304577.js";import{P as v}from"./PlusCircleOutlined-176a31dc.js";import{E as f}from"./EditOutlined-e081177a.js";import{T as S}from"./ToolOutlined-0d0725ac.js";import{S as T,C as b}from"./StopOutlined-b809cae3.js";import"./context-cb88fb1e.js";import"./responsiveObserve-b13564d4.js";import"./index-177532f7.js";import"./statusUtils-b010cbea.js";import"./EyeOutlined-319494bf.js";import"./SearchOutlined-03c63d28.js";import"./pickAttrs-1cd23dfa.js";import"./index-40784afc.js";import"./getScrollBarSize-c6833c2b.js";import"./isEqual-8ee5b3ce.js";import"./useForceUpdate-9ad39bdf.js";import"./index-0a1440ec.js";import"./ActionButton-e012fb99.js";import"./CheckOutlined-f0d55485.js";import"./Portal-08554165.js";const{TextArea:k}=d,{Option:I}=w,C={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:19}}};function N(){document.title="角色管理";const N=e(),O=s((e=>e.app.powersCode)),D=s((e=>e.sys.powerTreeData)),[A]=n.useForm(),[P,L]=a.useState([]),[z,R]=a.useState(!1),[q,E]=h({pageNum:1,pageSize:10,total:0}),[F,$]=h({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1}),[B,V]=h({title:void 0,conditions:void 0}),[M,U]=h({treeOnOkLoading:!1,powerTreeShow:!1,powerTreeDefault:{menus:[],powers:[]}});a.useEffect((()=>{Q(q),J(),Z()}),[]);const J=()=>{const e=o.getAllMenusAndPowers().data;N.sys.reducerSetAllPowers(e)},Q=async e=>{if(!O.includes("role:query"))return;const s={page:e.pageNum,limit:e.pageSize};R(!0);try{const a=await x.getRolesList(s);a&&200===a.code?(L(a.data),E({total:a.cont,pageNum:e.pageNum,pageSize:e.pageSize})):t.error((null==a?void 0:a.message)??"获取失败")}finally{R(!1)}},G=e=>{V({conditions:e})},[H,K]=a.useState({uuid:"",powerlist:{}}),W=(e,s)=>{$({modalShow:!0,nowData:e,operateType:s}),setTimeout((()=>{var a;if("add"===s)A.setFieldsValue({rolename:"",proxy:"",store:"",desc:"",limit:""});else{if(K({uuid:e.uuid,powerlist:{menuAndPowers:e.menuAndPowers}}),e.proxy&&"-"!==e.proxy){const s=null==(a=X.find((s=>s.label===e.proxy||s.value===e.proxy)))?void 0:a.value;se(s)}A.setFieldsValue({rolename:e.title,proxy:"-"===e.proxy?"":e.proxy,store:"-"===e.store?"":e.store,desc:e.desc,limit:e.limit.split("/")[1]})}}))},[X,Y]=a.useState([]),Z=async()=>{const e=(await x.getAgents()).data.map((e=>({label:e.providername,value:e.uuid})));Y(e)},[_,ee]=a.useState([]),se=async e=>{const s=(await x.getStores({agenuuid:e})).data.map((e=>({label:e.providername,value:e.uuid})));ee(s)},ae=()=>{A.setFieldsValue({rolename:"",proxy:"",store:"",desc:"",limit:""}),$({modalShow:!1})},oe=()=>{U({powerTreeShow:!1})},te=[{title:"编号",dataIndex:"serial",key:"serial"},{title:"角色名称",dataIndex:"title",key:"title"},{title:"所属门店",dataIndex:"store",key:"store"},{title:"所属代理",dataIndex:"proxy",key:"proxy"},{title:"角色说明",dataIndex:"desc",key:"desc"},{title:"数量限制",dataIndex:"limit",key:"limit"},{title:"状态",dataIndex:"conditions",key:"conditions",render:e=>1===e?i.jsx("span",{style:{color:"green"},children:"启用"}):i.jsx("span",{style:{color:"red"},children:"禁用"})},{title:"操作",key:"control",width:200,render:(e,s)=>{const a=[];O.includes("role:up")&&a.push(i.jsx("span",{className:"control-btn blue",onClick:()=>W(s,"up"),children:i.jsx(l,{placement:"top",title:"编辑角色",children:i.jsx(f,{})})},"1")),O.includes("role:power")&&a.push(i.jsx("span",{className:"control-btn blue",onClick:()=>(e=>{const s=e.menuAndPowers.map((e=>e.menuId)),a=e.menuAndPowers.reduce(((e,s)=>[...e,...s.powers]),[]);$({nowData:e}),U({powerTreeShow:!0,powerTreeDefault:{menus:s,powers:a}})})(s),children:i.jsx(l,{placement:"top",title:"分配权限",children:i.jsx(S,{})})},"2")),O.includes("role:del")&&a.push(i.jsx(m,{title:1===s.status?"确定禁用吗？":"确定启用吗？",onConfirm:()=>(async e=>{R(!0);try{let s;s=1===e.status?await x.closeRole({uuid:e.uuid}):await x.openRole({uuid:e.uuid}),s&&200===s.code?(t.success("删除成功"),Q(q)):t.error((null==s?void 0:s.message)??"操作失败")}finally{R(!1)}})(s),okText:"确定",cancelText:"取消",children:i.jsx("span",{className:"control-btn red",children:i.jsx(l,{placement:"top",title:1===s.status?"禁用":"启用",children:1===s.status?i.jsx(T,{}):i.jsx(b,{style:{color:"green"}})})})},"3"));const o=[];return a.forEach(((e,s)=>{s&&o.push(i.jsx(p,{type:"vertical"},`line${s}`)),o.push(e)})),o}}],ie=a.useMemo((()=>P.map(((e,s)=>({key:e.id,uuid:e.uuid,serial:s+1+(q.pageNum-1)*q.pageSize,title:e.rolename,store:e.providerinfor?e.providerinfor.providername:"-",storeId:e.providerinfor?e.providerinfor.uuid:"-",proxy:e.agentinfor?e.agentinfor.providername:"-",proxyId:e.agentinfor?e.agentinfor.uuid:"-",limit:`${e.usernum}/${e.maxvolumne}`,maxLimit:e.maxvolumne,usedLimit:e.usernum,desc:e.roledetail?e.roledetail.remarks:"-",sorts:1,conditions:e.deletedtime?0:1,status:e.deletedtime?0:1,control:1,menuAndPowers:e.roledetail&&e.roledetail.powerlist?e.roledetail.powerlist.menuAndPowers:[]})))),[q,P]);return i.jsxs("div",{className:"role-box",children:[i.jsxs("div",{className:"g-search",children:[O.includes("role:query")&&i.jsxs("ul",{className:"search-ul",children:[i.jsxs("li",{className:"search-item",children:[i.jsx("span",{className:"item-lable",children:"门店名称:"}),i.jsx(d,{placeholder:"请输门店名称",onChange:e=>{e.target.value.length<20&&V({title:e.target.value})},value:B.title})]}),i.jsxs("li",{className:"search-item",children:[i.jsx("span",{className:"item-lable",children:"门店类型:"}),i.jsxs(w,{placeholder:"请选择状态",allowClear:!0,style:{width:"100px"},onChange:G,value:B.conditions,children:[i.jsx(I,{value:1,children:"启用"}),i.jsx(I,{value:-1,children:"禁用"})]})]}),i.jsxs("li",{className:"search-item",children:[i.jsx("span",{className:"item-lable",style:{width:"60px"},children:"代理:"}),i.jsxs(w,{placeholder:"请选择状态",allowClear:!0,style:{width:"100px"},onChange:G,value:B.conditions,children:[i.jsx(I,{value:1,children:"启用"}),i.jsx(I,{value:-1,children:"禁用"})]})]}),i.jsx("li",{children:i.jsx(r,{type:"primary",icon:i.jsx(g,{}),onClick:()=>{Q(q)},children:"搜索"})})]}),i.jsx("ul",{className:"search-func",children:O.includes("role:add")&&i.jsx("li",{children:i.jsx(r,{type:"primary",icon:i.jsx(v,{}),disabled:!O.includes("role:add"),onClick:()=>W(null,"add"),children:"新增角色"})})})]}),i.jsx("div",{className:"diy-table",children:i.jsx(u,{columns:te,loading:z,dataSource:ie,pagination:{total:q.total,current:q.pageNum,pageSize:q.pageSize,showQuickJumper:!1,showTotal:e=>`共 ${e} 条数据`,onChange:(e,s)=>((e,s)=>{Q({pageNum:e,pageSize:s||q.pageSize})})(e,s)}})}),i.jsx(y,{title:{add:"新增角色",up:"编辑角色",see:"查看"}[F.operateType],open:F.modalShow,cancelText:"取消",okText:"确认",onOk:()=>(async()=>{var e,s;if("see"!==F.operateType)try{const a=await A.validateFields();if($({modalLoading:!0}),"add"===F.operateType){const e={rolename:a.rolename,useruuid:a.proxy,provideruuid:a.store,maxvolumne:a.limit,powerlist:{menuAndPowers:[{menuId:0,powers:[]}]},remarks:a.desc};try{const s=await x.addRole(e);s&&200===s.code&&(t.success("添加成功"),Q(q),ae())}finally{$({modalLoading:!1})}}else{const o=null==(e=_.find((e=>e.label===a.store||e.value===a.store)))?void 0:e.value,i=null==(s=X.find((e=>e.label===a.proxy||e.value===a.proxy)))?void 0:s.value,r={uuid:H.uuid,rolename:a.rolename,useruuid:i,provideruuid:o,maxvolumne:a.limit,powerlist:H.powerlist,remarks:a.desc};try{const e=await x.updateRole(r);e&&200===e.code&&(t.success("修改成功"),Q(q),ae())}finally{$({modalLoading:!1})}}}catch{}else ae()})(),onCancel:()=>ae(),confirmLoading:F.modalLoading,children:i.jsxs(n,{form:A,initialValues:{formConditions:1},children:[i.jsx(n.Item,{label:"角色名称",name:"rolename",...C,rules:[{required:!0,whitespace:!0,message:"请输入角色名称"},{max:20,message:"最多输入20位字符"}],children:i.jsx(d,{placeholder:"请输入角色名",disabled:"see"===F.operateType})}),i.jsx(n.Item,{label:"所属代理",name:"proxy",...C,rules:[{required:!0,message:"请选择所属代理"}],children:i.jsx(w,{disabled:"see"===F.operateType,options:X,onSelect:se,placeholder:"请选择所属代理"})}),i.jsx(n.Item,{label:"所属门店",name:"store",...C,rules:[{required:!0,message:"请选择所属门店"}],children:i.jsx(w,{disabled:"see"===F.operateType,options:_,placeholder:"请选择所属门店"})}),i.jsx(n.Item,{label:"角色描述",name:"desc",...C,rules:[{max:200,message:"最多输入200个字符"},{required:!0,message:"请输入角色描述"}],children:i.jsx(k,{rows:4,disabled:"see"===F.operateType,autoSize:{minRows:2,maxRows:6}})}),i.jsx(n.Item,{label:"数量限制",name:"limit",...C,rules:[{required:!0,message:"请输入数量限制"}],children:i.jsx(c,{min:0,max:99,style:{width:"100%"},disabled:"see"===F.operateType})})]})}),i.jsx(j,{title:F.nowData?`权限：${F.nowData.title}`:"分配权限",data:D,defaultChecked:M.powerTreeDefault,loading:M.treeOnOkLoading,modalShow:M.powerTreeShow,onOk:async e=>{var s;if(!(null==(s=null==F?void 0:F.nowData)?void 0:s.uuid))return void t.error("该数据没有ID");const a={id:F.nowData.uuid,menus:e.menus,powers:e.powers};U({treeOnOkLoading:!0});try{const e=o.setPowersByRoleId(a),s={uuid:F.nowData.uuid,rolename:F.nowData.title,useruuid:F.nowData.proxyId,provideruuid:F.nowData.storeId,maxvolumne:F.nowData.maxLimit,powerlist:{menuAndPowers:e.data},remarks:F.nowData.desc},i=await x.updateRole(s);i&&200===i.code?(t.success("操作成功"),Q(q),oe()):t.error((null==i?void 0:i.message)??"权限分配失败")}finally{U({treeOnOkLoading:!1})}},onClose:oe})]})}export{N as default};
